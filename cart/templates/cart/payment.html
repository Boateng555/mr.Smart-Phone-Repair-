{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment</title>
  <link rel="stylesheet" href="{% static 'styles/onlineshop.css' %}">
  <link rel="stylesheet" href="{% static 'styles/payment.css' %}">
  <!-- Include PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID&currency=EUR"></script>
</head>
<body>
  <header>
    <nav class="navbar">
      <div class="logo">
        <a href="index.html"><img src="{% static 'assets/Images/MrSmartRepair.JPG'%}" alt="Logo" /></a>
      </div>
      <div class="nav-right">
        <a href="{% url 'cart' %}">Warenkorb</a>
        <a href="{% url 'konto' %}">Login / Register</a>
      </div>
      <div class="menu-icon" onclick="toggleMenu()">
        &#9776;
      </div>
    </nav>
  </header>

  <main>
    <h1>Zahlung</h1>

    <!-- Payment Method Selection -->
    <section id="payment-method">
      <h2>Wählen Sie eine Zahlungsmethode:</h2>
      <div class="payment-options">
        <label>
          <input type="radio" name="payment-method" value="credit-card" checked> Kreditkarte
        </label>
        <label>
          <input type="radio" name="payment-method" value="paypal"> PayPal
        </label>
        <label>
          <input type="radio" name="payment-method" value="bank-transfer"> Überweisung
        </label>
      </div>
    </section>

    <!-- Credit Card Payment Form -->
    <section id="credit-card-form" class="payment-form">
      <h2>Kreditkartenzahlung</h2>
      <form id="credit-card-payment-form" method="post" action="{% url 'payment' %}">
        {% csrf_token %}
        <label for="card-name">Karteninhaber Name</label>
        <input type="text" id="card-name" name="card-name" required>

        <label for="card-number">Kartennummer</label>
        <input type="text" id="card-number" name="card-number" maxlength="16" required>

        <label for="expiry-date">Ablaufdatum</label>
        <input type="month" id="expiry-date" name="expiry-date" required>

        <label for="cvv">CVV</label>
        <input type="text" id="cvv" name="cvv" maxlength="3" required>

        <p>Gesamtbetrag zu zahlen: <span id="payment-total">€{{ total }}</span></p>

        <input type="hidden" name="total" value="{{ total }}">

        <button type="submit">Zahlung abschicken</button>
      </form>
    </section>

    <!-- PayPal Payment Button -->
    <section id="paypal-form" class="payment-form" style="display: none;">
      <h2>PayPal-Zahlung</h2>
      <div id="paypal-button-container"></div>
    </section>
    <script>
      // Render PayPal button
      paypal.Buttons({
        createOrder: function(data, actions) {
          // Set up the transaction
          return actions.order.create({
            purchase_units: [{
              amount: {
                value: '{{ total }}' // Total amount from Django context
              }
            }]
          });
        },
        onApprove: function(data, actions) {
          // Capture the payment
          return actions.order.capture().then(function(details) {
            // Redirect to a success page or handle the payment confirmation
            alert('Payment completed by ' + details.payer.name.given_name);
            window.location.href = "{% url 'payment_success' %}"; // Redirect to success page
          });
        },
        onError: function(err) {
          // Handle errors
          console.error(err);
          alert('Payment failed. Please try again.');
        }
      }).render('#paypal-button-container'); // Display the PayPal button
    </script>

    <!-- Bank Transfer Information -->
    <section id="bank-transfer-form" class="payment-form" style="display: none;">
      <h2>Überweisung</h2>
      <p>Bitte überweisen Sie den Gesamtbetrag von <strong>€{{ total }}</strong> auf folgendes Konto:</p>
      <p>
        <strong>Bank:</strong> Beispielbank<br>
        <strong>IBAN:</strong> DE00 1234 5678 9012 3456 78<br>
        <strong>BIC:</strong> EXAMPLEBIC<br>
        <strong>Verwendungszweck:</strong> Bestellung #12345
      </p>
      <p>Nach Eingang der Zahlung wird Ihre Bestellung versendet.</p>
    </section>
  </main>

  <script src="{% static 'scripts/payment.js' %}"></script>
  <script>
    // Show/hide payment forms based on selected payment method
    const paymentMethods = document.querySelectorAll('input[name="payment-method"]');
    const creditCardForm = document.getElementById('credit-card-form');
    const paypalForm = document.getElementById('paypal-form');
    const bankTransferForm = document.getElementById('bank-transfer-form');

    paymentMethods.forEach(method => {
      method.addEventListener('change', (event) => {
        const selectedMethod = event.target.value;

        // Hide all forms
        creditCardForm.style.display = 'none';
        paypalForm.style.display = 'none';
        bankTransferForm.style.display = 'none';

        // Show the selected form
        if (selectedMethod === 'credit-card') {
          creditCardForm.style.display = 'block';
        } else if (selectedMethod === 'paypal') {
          paypalForm.style.display = 'block';
        } else if (selectedMethod === 'bank-transfer') {
          bankTransferForm.style.display = 'block';
        }
      });
    });

    // Render PayPal button
    paypal.Buttons({
      createOrder: function(data, actions) {
        return actions.order.create({
          purchase_units: [{
            amount: {
              value: '{{ total }}' // Total amount from Django context
            }
          }]
        });
      },
      onApprove: function(data, actions) {
        return actions.order.capture().then(function(details) {
          alert('Payment completed by ' + details.payer.name.given_name);
          window.location.href = "{% url 'payment_success' %}"; // Redirect to success page
        });
      },
      onError: function(err) {
        console.error(err);
        alert('Payment failed. Please try again.');
      }
    }).render('#paypal-button-container');
  </script>
</body>
</html>